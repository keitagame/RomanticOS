# RustOS カーネルアーキテクチャ詳細

## 1. メモリ管理

### 1.1 ページング
- **ページサイズ**: 4KB (4096バイト)
- **アドレス空間**: 64ビット仮想アドレス
- **ページテーブル**: 4レベル (PML4 → PDP → PD → PT)

### 1.2 メモリレイアウト
```
0xFFFF_FFFF_FFFF_FFFF ┌─────────────────┐
                      │  カーネル空間    │
0xFFFF_8000_0000_0000 ├─────────────────┤
                      │    (未使用)      │
0x0000_8000_0000_0000 ├─────────────────┤
                      │  ユーザー空間    │
0x0000_0000_0000_0000 └─────────────────┘
```

### 1.3 ヒープ管理
- **アロケータ**: linked_list_allocator
- **ヒープ開始**: 0x_4444_4444_0000
- **初期サイズ**: 100KB
- **拡張**: 必要に応じて追加ページを割り当て

## 2. プロセス管理

### 2.1 プロセス構造
```rust
Process {
    pid: usize,              // プロセスID
    state: ProcessState,     // 状態
    context: ProcessContext, // レジスタ
    kernel_stack: Vec<u8>,   // カーネルスタック
    user_stack: VirtAddr,    // ユーザースタック
    page_table: VirtAddr,    // ページテーブル
    priority: u8,            // 優先度
    time_slice: usize,       // タイムスライス
}
```

### 2.2 プロセス状態遷移
```
    ┌─────────────┐
    │   Created   │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │    Ready    │◄──────┐
    └──────┬──────┘       │
           │              │
           ▼              │
    ┌─────────────┐       │
    │   Running   │───────┘
    └──────┬──────┘
           │
           ├─────────────►┌─────────────┐
           │              │   Blocked   │
           │              └─────────────┘
           │
           ▼
    ┌─────────────┐
    │ Terminated  │
    └─────────────┘
```

### 2.3 スケジューリング
- **アルゴリズム**: ラウンドロビン
- **タイムクォンタ**: 10ティック (100ms)
- **キュー**: ready_queue (FIFO)

## 3. システムコール

### 3.1 呼び出し規約
```
レジスタマッピング:
rax - システムコール番号
rdi - 引数1
rsi - 引数2
rdx - 引数3
r10 - 引数4
r8  - 引数5
r9  - 引数6

戻り値: rax
```

### 3.2 システムコール一覧
| 番号 | 名前 | 説明 |
|------|------|------|
| 0 | read | ファイル読み込み |
| 1 | write | ファイル書き込み |
| 2 | open | ファイルオープン |
| 3 | close | ファイルクローズ |
| 9 | mmap | メモリマッピング |
| 11 | munmap | メモリマッピング解除 |
| 35 | sleep | スリープ |
| 39 | getpid | PID取得 |
| 57 | fork | プロセス複製 |
| 59 | execve | プログラム実行 |
| 60 | exit | プロセス終了 |

### 3.3 システムコールフロー
```
ユーザー空間
    │
    │ int 0x80
    ▼
割り込みハンドラ
    │
    ▼
syscall_handler()
    │
    ▼
各システムコール実装
    │
    ▼
カーネル処理
    │
    │ rax に戻り値
    ▼
ユーザー空間に復帰
```

## 4. ファイルシステム

### 4.1 VFS構造
```
VirtualFileSystem
├── Inode[] (inodeテーブル)
│   ├── inode_num
│   ├── file_type (Regular/Directory/Device)
│   ├── mode (read/write/execute)
│   ├── size
│   ├── data (ファイル内容)
│   └── children (ディレクトリエントリ)
│
└── OpenFile[] (ファイルディスクリプタテーブル)
    ├── inode
    ├── offset
    └── flags
```

### 4.2 ディレクトリ構造
```
/ (root)
├── dev/
├── tmp/
├── home/
└── hello.txt
```

### 4.3 I/O操作
1. **open()**: パスからinodeを検索 → FDを割り当て
2. **read()**: FDからinode取得 → dataから読み込み → offsetを更新
3. **write()**: FDからinode取得 → dataに書き込み → offsetを更新
4. **close()**: FDを解放

## 5. 割り込み処理

### 5.1 割り込みベクタ
| ベクタ | 種類 | ハンドラ |
|--------|------|---------|
| 0-31 | CPU例外 | 例外ハンドラ |
| 32 | Timer (IRQ0) | timer_interrupt_handler |
| 33 | Keyboard (IRQ1) | keyboard_interrupt_handler |
| 0x80 | System Call | syscall_interrupt_handler |

### 5.2 割り込み処理フロー
```
ハードウェア割り込み
    │
    ▼
CPU (割り込み検知)
    │
    ▼
IDT参照
    │
    ▼
割り込みハンドラ
    │
    ├─ コンテキスト保存
    │
    ├─ 処理実行
    │
    ├─ EOI送信 (PIC)
    │
    └─ コンテキスト復帰
    │
    ▼
処理継続
```

### 5.3 PIC (8259) 設定
- **PIC1 オフセット**: 32 (IRQ0-7)
- **PIC2 オフセット**: 40 (IRQ8-15)
- **マスク**: Timer, Keyboardのみ有効

## 6. デバイスドライバ

### 6.1 VGAドライバ
- **モード**: テキストモード 80x25
- **バッファアドレス**: 0xb8000
- **フォーマット**: 各文字2バイト (ASCII + 色)
- **スクロール**: 行全体を上にシフト

### 6.2 キーボードドライバ
- **ポート**: 0x60 (データ)
- **スキャンコードセット**: Set 1
- **バッファサイズ**: 256バイト
- **処理**: スキャンコード → ASCII変換

### 6.3 タイマードライバ
- **デバイス**: PIT (8253/8254)
- **周波数**: 100Hz (10ms間隔)
- **用途**: スケジューリング、時刻管理

## 7. ブートプロセス

```
1. BIOS/UEFI
   │
   ▼
2. Bootloader (bootloader crate)
   │
   ├─ ページングセットアップ
   ├─ カーネルロード
   └─ カーネルにジャンプ
   │
   ▼
3. kernel_main()
   │
   ├─ GDT初期化
   ├─ IDT初期化
   ├─ メモリ管理初期化
   ├─ ヒープ初期化
   ├─ プロセス管理初期化
   ├─ ファイルシステム初期化
   ├─ ドライバ初期化
   └─ システムコール初期化
   │
   ▼
4. initプロセス起動
   │
   ▼
5. スケジューラ開始
```

## 8. コンテキストスイッチ

### 8.1 保存されるレジスタ
- 汎用レジスタ: rax, rbx, rcx, rdx, rsi, rdi, r8-r15
- スタックポインタ: rsp, rbp
- 命令ポインタ: rip
- フラグレジスタ: rflags

### 8.2 切り替え手順
```
1. タイマー割り込み
   │
   ▼
2. 現在のプロセスのコンテキストを保存
   │
   ▼
3. スケジューラが次のプロセスを選択
   │
   ▼
4. 次のプロセスのコンテキストを復元
   │
   ▼
5. 次のプロセスの実行再開
```

## 9. セキュリティ考慮事項

### 9.1 特権レベル
- **Ring 0**: カーネル
- **Ring 3**: ユーザープロセス (未実装)

### 9.2 メモリ保護
- ページレベルでの読み書き実行権限
- ユーザー/カーネルアクセス制御
- NX (No eXecute) ビット

### 9.3 制限事項
⚠️ この実装は教育目的であり、以下が欠けています:
- ASLR (Address Space Layout Randomization)
- スタックカナリア
- セキュアブート
- サンドボックス機構

## 10. パフォーマンス最適化

### 10.1 メモリ最適化
- Zero-copy設計
- ページの遅延割り当て (未実装)
- Copy-on-Write (未実装)

### 10.2 スケジューリング最適化
- O(1)スケジューラ候補
- プライオリティベースプリエンプション
- CPU親和性 (SMP時)

### 10.3 I/O最適化
- バッファリング
- 非同期I/O (未実装)
- DMA転送 (未実装)
