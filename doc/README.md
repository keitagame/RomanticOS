# RustOS Kernel

Rustで実装された教育用OSカーネルです。以下の機能を実装しています。

## 実装機能

### 1. メモリ管理
- **ページング**: x86_64の4レベルページテーブル
- **仮想メモリ**: ユーザー空間とカーネル空間の分離
- **ヒープアロケータ**: linked_list_allocatorによる動的メモリ割り当て
- **フレームアロケータ**: 物理メモリフレームの管理

### 2. プロセス管理
- **プロセス構造体**: PID、状態、コンテキスト管理
- **スケジューラ**: ラウンドロビン方式
- **コンテキストスイッチ**: レジスタ保存/復元
- **プロセス状態**: Ready, Running, Blocked, Terminated

### 3. システムコール
実装されているシステムコール:
- `read()` / `write()` - ファイル/デバイスI/O
- `open()` / `close()` - ファイル操作
- `exit()` - プロセス終了
- `fork()` - プロセス複製 (骨組み)
- `execve()` - プログラム実行 (骨組み)
- `getpid()` - プロセスID取得
- `mmap()` / `munmap()` - メモリマッピング
- `sleep()` - スリープ

### 4. ファイルシステム
- **VFS (Virtual File System)**: 仮想ファイルシステム
- **Inode管理**: ファイル/ディレクトリのメタデータ
- **ディレクトリ構造**: 階層的なディレクトリ
- **ファイルディスクリプタ**: オープンファイルの管理

### 5. デバイスドライバ
- **VGAドライバ**: テキストモード80x25
- **キーボードドライバ**: PS/2キーボード、スキャンコード処理
- **タイマードライバ**: PIT (Programmable Interval Timer)

### 6. 割り込み処理
- **IDT (Interrupt Descriptor Table)**: 割り込みハンドラ登録
- **例外処理**: ページフォルト、ダブルフォルトなど
- **ハードウェア割り込み**: タイマー、キーボード
- **PIC**: 8259 割り込みコントローラ

## アーキテクチャ

```
┌─────────────────────────────────────────┐
│         ユーザープロセス                │
├─────────────────────────────────────────┤
│        システムコールインターフェース      │
├─────────────────────────────────────────┤
│  プロセス管理  │  メモリ管理  │  VFS   │
├─────────────────────────────────────────┤
│     デバイスドライバ (VGA/KB/Timer)      │
├─────────────────────────────────────────┤
│    割り込み処理 (IDT/GDT)               │
├─────────────────────────────────────────┤
│         ハードウェア (x86_64)           │
└─────────────────────────────────────────┘
```

## ビルド方法

### 前提条件
```bash
# Rustツールチェーン
rustup default nightly

# bootimageツール
cargo install bootimage

# LLVMツール
rustup component add llvm-tools-preview
```

### ビルド
```bash
cargo build --release
```

### 実行 (QEMU)
```bash
# QEMUが必要
cargo run --release
```

## ファイル構造

```
src/
├── main.rs              # カーネルエントリーポイント
├── memory.rs            # メモリ管理
├── process.rs           # プロセス管理とスケジューラ
├── syscall.rs           # システムコール実装
├── filesystem.rs        # ファイルシステム
├── gdt.rs              # GDT設定
├── interrupts.rs        # 割り込み処理
└── drivers/
    ├── mod.rs          # ドライバ初期化
    ├── vga.rs          # VGAテキストモード
    ├── keyboard.rs     # キーボード入力
    └── timer.rs        # タイマー
```

## 主要な実装の詳細

### メモリ管理
- ページサイズ: 4KB
- ヒープサイズ: 100KB (拡張可能)
- ユーザー空間開始: 0x0000_4000_0000_0000
- カーネル空間: 上位半分

### プロセス管理
- カーネルスタック: 8KB/プロセス
- ユーザースタック: 16KB/プロセス (デフォルト)
- タイムスライス: 10ティック (100ms)
- スケジューリング: ラウンドロビン

### ファイルシステム
- 最大ファイルサイズ: 1MB
- 最大オープンファイル数: 1024
- Inode数: 1024

## テストプロセス

カーネルは起動時に以下を実行します:
1. initプロセス (PID 1) を起動
2. 2つのテストプロセスを起動
3. スケジューラによりプロセス間で切り替え

## 制限事項

このカーネルは教育目的であり、以下の制限があります:
- マルチコアサポートなし
- ネットワークスタックなし
- 永続ストレージなし (RAMディスクのみ)
- 限定的なドライバサポート
- セキュリティ機能の省略

## 今後の拡張

- [ ] マルチプロセッササポート (SMP)
- [ ] スワッピング機能
- [ ] より高度なスケジューラ (CFS等)
- [ ] ext2/FAT32ファイルシステム
- [ ] ディスクドライバ (ATA/AHCI)
- [ ] ネットワークスタック (TCP/IP)
- [ ] ELFローダー
- [ ] シェル実装

## ライセンス

MIT License

## 参考資料

- [Writing an OS in Rust](https://os.phil-opp.com/)
- [The Rust Programming Language](https://doc.rust-lang.org/book/)
- [OSDev Wiki](https://wiki.osdev.org/)
- [Intel 64 and IA-32 Architectures Software Developer's Manual](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)
